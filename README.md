# mkv_tracks_batch_merge
MKV batch operation

##简介
之前一直有为剧集视频封装字幕的需求，在网上搜索过很多批量封装mkv的信息，最详细的一个也只停留在批处理脚本的水平，所以想到从头设计一个以批量处理为中心的mkvmerge界面。
一开始只是想着批量添加字幕，但对mkvmerge加深了解后发现除了字幕还可以批量封装任何文件的任何轨道；当然目前还可以在界面中看到大量残留的最初字幕导向的提示。
目前批量封装能做到按不同模式复制原视频文件中的音频与字幕轨道，按规则指定外挂字幕的语言和标题等，如果有需求可能继续扩充（说实话感觉再扩充完全就是个正经的GUI了）。

##安装说明
本软件完全由Lua编写，没有进行exe封装，所以运行前需要先配置lua运行环境
个人推荐安装LuaDist：http://luadist.org/
请根据平台选择LuaDist版本（理论支持能运行LuaDist的任何平台，但我没试过也不保证）
下载后解压压缩包到任意路径，选择“我的电脑/此电脑”->右键->属性->高级系统设置->高级->环境变量->系统变量/新建，将变量名设为LUA_DIST_HOME，变量值为解压出的文件夹的路径（Win10就直接点浏览目录选择），然后选系统变量中的Path->编辑，win10下直接点新建并输入%LUA_DIST_HOME%\bin，没有新建则在变量值末尾添加%LUA_DIST_HOME%\bin并保证前面有英文分号做分隔，然后就可以运行本软件目录下的run.bat了。
本软件需要系统中已经有MKVmerge程序（MKVToolNix中就有，小丸也附带），并且路径名中不能有空格。

##使用说明
每次运行请选择run.bat。界面部分因为不是比较高级的GUI库所以会有很多布局问题（列表没法横向完全显示，窗口大小不合理等），得手动拉一下。第一次运行会要求选择mkvmerge文件，否则无法工作。

如果需要修改软件的轨道设置，请选择config template进入设置界面。如果要对已经存在的设置模板进行修改只需要在最上方的下拉列表里选择对应的名称，更改下方的属性，然后点save change即可；删除时选择列表中的模板名称并点delete；创建新模板要点new，在弹出窗口内输入模板名称，然后修改设置值，最后点save change才算完成。进行修改后要点最下方的apply才会保存修改。

界面中的ouput dir为文件输出路径，如果没有选择是不能进行处理的。

软件复制文件音频与字幕轨道的逻辑分成4种：all，match，first与none。all为全部复制，match为语言码包含在priority中的轨道，first为存在的priority中优先级最高的语言码，none为不复制任何轨道。有效的语言码请搜索ISO639-2。
外挂字幕的语言设置与标题设置逻辑是依次选择。比如外挂语言选择为chi，eng的话，第一个外挂字幕的语言会设为chi，第二个为eng，再往后全部为eng；标题逻辑相同。

默认字幕轨道的选择模式有两种：auto和first external。auto为自动，如果原视频有默认轨道则使用原视频轨道；first external则为第一个外挂字幕。

界面中有两个列表，左边为所有已添加的文件，右边为对应所选文件的相关轨道设置，对两个列表进行删除需要分别点击delete selected file和delete selected track。clear all则会清除所有内容。

整个软件的一大核心是字幕的批量分配。这里并不是使用的同名逻辑进行分配——考虑到经常有字幕名字和视频名字相差太多的情况，改哪个都很闹心。点击add tracks的话会自动挨个为视频按顺序指定选择的字幕；建议的情况是视频与字幕数目是1：1，且视频排列顺序与字幕排列顺序相同。如果两者数目不一致，比如1：2，则按比例每n个连续字幕匹配一个视频。如果字幕数目不够整数倍则能加多少加多少。

选择完文件与字幕后点击process进行处理。目前没找到好的方法在处理时同步更新UI，会出现界面假死的问题，不过控制台会有正常输出，不要在无响应后强制结束程序。如果怀疑出现死机问题请查看任务管理器，如果缺少mkvmerge进程或者CPU占用率在个位数，就可以强制关闭了。
